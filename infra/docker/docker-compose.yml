services:
  jellyfin-dev:
    image: jellyfin/jellyfin:10.11.3
    container_name: jellyfin-dev
    ports:
      - "8096:8096"
    volumes:
      - ./config:/config
      - jellyfin-cache:/cache
      - ~/Videos/Movies/:/media/Movies:ro
      - ../../clients/web-plugin:/jellyfin/jellyfin-web/plugins/opensyncparty:ro
      - ../../plugins/jellyfin/OpenSyncParty/dist:/config/plugins/OpenSyncParty
    entrypoint:
      - /bin/bash
      - -c
      - |
        if ! grep -q "/OpenSyncParty/ClientScript" /jellyfin/jellyfin-web/index.html; then
          sed -i 's|</body>|<script src="/OpenSyncParty/ClientScript"></script></body>|' /jellyfin/jellyfin-web/index.html
          echo "Injected OpenSyncParty script URL into index.html"
        fi
        /jellyfin/jellyfin

  plugin-builder:
    image: mcr.microsoft.com/dotnet/sdk:9.0
    working_dir: /src
    network_mode: host
    volumes:
      - ../../plugins/jellyfin/OpenSyncParty:/src
      - ../../plugins/jellyfin/OpenSyncParty/dist:/out
    command: dotnet publish -c Release -o /out OpenSyncPartyPlugin.csproj /p:UseLocalJellyfinRefs=true

volumes:
  jellyfin-cache:
