services:
  jellyfin-dev:
    image: jellyfin/jellyfin:10.11.3
    container_name: jellyfin-dev
    ports:
      - "8096:8096"
    volumes:
      - ./config:/config
      - jellyfin-cache:/cache
      - ~/Videos/Movies/:/media/Movies:ro
      - ../../clients/web-plugin:/jellyfin/jellyfin-web/plugins/opensyncparty:ro
      - ../../plugins/jellyfin/OpenSyncParty/dist:/config/plugins/OpenSyncParty
    entrypoint:
      - /bin/bash
      - -c
      - |
        # Cache busting timestamp
        TS=$$(date +%s)
        # Remove old injection if exists (to avoid duplicates/stale versions)
        sed -i '/OpenSyncParty\/ClientScript/d' /jellyfin/jellyfin-web/index.html
        
        # Inject new version
        sed -i "s|</body>|<script src=\"/OpenSyncParty/ClientScript?v=$$TS\"></script></body>|" /jellyfin/jellyfin-web/index.html
        echo "Injected OpenSyncParty script into index.html with cache buster v=$$TS"
        
        /jellyfin/jellyfin

  plugin-builder:
    image: mcr.microsoft.com/dotnet/sdk:9.0
    working_dir: /src
    network_mode: host
    volumes:
      - ../../plugins/jellyfin/OpenSyncParty:/src
      - ../../plugins/jellyfin/OpenSyncParty/dist:/out
    command: dotnet publish -c Release -o /out OpenSyncPartyPlugin.csproj /p:UseLocalJellyfinRefs=true

volumes:
  jellyfin-cache:
